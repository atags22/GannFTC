#pragma config(Hubs,  S1, HTMotor,  HTMotor,  HTServo,  HTMotor)
#pragma config(Hubs,  S2, HTServo,  none,     none,     none)
#pragma config(Sensor, S1,     ,               sensorI2CMuxController)
#pragma config(Sensor, S2,     ,               sensorI2CMuxController)
#pragma config(Motor,  motorA,           ,             tmotorNXT, openLoop)
#pragma config(Motor,  motorB,           ,             tmotorNXT, openLoop)
#pragma config(Motor,  motorC,           ,             tmotorNXT, openLoop)
#pragma config(Motor,  mtr_S1_C1_1,     omniBR,        tmotorTetrix, PIDControl, encoder)
#pragma config(Motor,  mtr_S1_C1_2,     omniBL,        tmotorTetrix, PIDControl, encoder)
#pragma config(Motor,  mtr_S1_C2_1,     omniFR,        tmotorTetrix, PIDControl, encoder)
#pragma config(Motor,  mtr_S1_C2_2,     omniFL,        tmotorTetrix, PIDControl, encoder)
#pragma config(Motor,  mtr_S1_C4_1,     liftL,         tmotorTetrix, openLoop)
#pragma config(Motor,  mtr_S1_C4_2,     liftR,         tmotorTetrix, openLoop)
#pragma config(Servo,  srvo_S1_C3_1,    servoFL,              tServoStandard)
#pragma config(Servo,  srvo_S1_C3_2,    servoBL,              tServoStandard)
#pragma config(Servo,  srvo_S1_C3_3,    servoBR,              tServoStandard)
#pragma config(Servo,  srvo_S1_C3_4,    servoFR,              tServoStandard)
#pragma config(Servo,  srvo_S1_C3_5,    servL,                tServoStandard)
#pragma config(Servo,  srvo_S1_C3_6,    servR,                tServoStandard)
#pragma config(Servo,  srvo_S2_C1_1,    servClaw,             tServoStandard)
#pragma config(Servo,  srvo_S2_C1_2,    servo8,               tServoNone)
#pragma config(Servo,  srvo_S2_C1_3,    servo9,               tServoNone)
#pragma config(Servo,  srvo_S2_C1_4,    servo10,              tServoNone)
#pragma config(Servo,  srvo_S2_C1_5,    servo11,              tServoNone)
#pragma config(Servo,  srvo_S2_C1_6,    servo12,              tServoNone)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#include "JoystickDriver.c"
float TELE_OP_SCALE = 0.85;	// 0.85 = regular, 0.3 = accuramode
#define JOY_SCALE 0.78	//scales down the values from the algorithm for getting motor values from the joystick because otherwise they are too large - is equal to 100 / 128 because 128 is the highest value the joystick has
#define JOY_THRESHOLD 30		//threshold for when joystick value is considered zero, because there is a good amount of noise in the joysticks
#define SQR(val) (val) * (val) // square function`
bool lifted = false; // whether to set the motors
// servo positions
#define CLAW_OPEN 180
#define CLAW_CLOSED 135
#define LIFT_SPEED 80 // lifting motors' speed
#define COUNTER_MAX 60 // for not looping the button commands
#define SERVO_INCREMENT 10 // for tilting the tilter
#define OMNI_DEFAULT 127 //Default position for omni wheels the regular Gann way

#define FR_REG 255
#define FL_REG 0
#define BL_REG 255
#define BR_REG 0
// button counters - they're incremented when buttons are pressed until they hit COUNTER_MAX
int counterClaw = 0;
int counterTiltForward = 0;
int counterTiltBackward = 0;
int counterSmoothen = 0;
bool wheelRotState = false;

task main()
{
	while (true)
	{
		if (joy1Btn(2) == 1)
		{
			wheelRotState = !wheelRotState;
		}

		if (wheelRotState)
		{
			servo[servoFR] = FR_REG;
			servo[servoFL] = FL_REG;
			servo[servoBL] = BL_REG;
			servo[servoBR] = BR_REG;
		}

		if (!wheelRotState)
		{
			servo[servoFR] = OMNI_DEFAULT;
			servo[servoFL] = OMNI_DEFAULT;
			servo[servoBL] = OMNI_DEFAULT;
			servo[servoBR] = OMNI_DEFAULT;
		}

		//reset lifted
		lifted = false;

		// Set up joystick
		getJoystickSettings(joystick);

		// Drive teleop
		float moveX, moveY; int rotate;

		if (abs(joystick.joy1_x2) < JOY_THRESHOLD) // noise
		{
			rotate = 0;
		}
		else rotate = joystick.joy1_x2 * TELE_OP_SCALE * JOY_SCALE;

		// Check for noise
		if ((sqrt(SQR(joystick.joy1_x1) + SQR(joystick.joy1_y1)) < JOY_THRESHOLD))
		{
			moveX = 0;
			moveY = 0;
		}
		else // actual control
		{
			moveX = joystick.joy1_x1;
			moveY = joystick.joy1_y1;
		}
		// Set the motors
		motor[omniFR] = TELE_OP_SCALE * JOY_SCALE * (moveX - moveY) + rotate;
		motor[omniBR] = TELE_OP_SCALE * JOY_SCALE * (-moveX - moveY) + rotate;
		motor[omniFL] = TELE_OP_SCALE * JOY_SCALE * (moveX + moveY) + rotate;
		motor[omniBL] = TELE_OP_SCALE * JOY_SCALE * (-moveX + moveY) + rotate;

		// set the claw
		if (joy2Btn(2))
		{
			// check the counter
			if (counterClaw < COUNTER_MAX)
			{
				counterClaw++;
			}
			else
			{
				if (ServoValue[servClaw] == CLAW_OPEN)
				{
					servo[servClaw] = CLAW_CLOSED;
				}
				else
				{
					servo[servClaw] = CLAW_OPEN;
				}
				counterClaw = 0;
			}
		}
		else counterClaw = 0;

		// tilt forward
		if (joystick.joy2_y2 > 100)
		{
			if (counterTiltForward < COUNTER_MAX + 20)
			{
				counterTiltForward++;
			}
			else
			{
				if (ServoValue[servL] < 255 - SERVO_INCREMENT)
				{
					servo[servL] += SERVO_INCREMENT;
					servo[servR] -= SERVO_INCREMENT;
				}
				counterTiltForward = 0;
			}
		}
		else if (joystick.joy2_y2 < -100)
		{
			if (counterTiltBackward < COUNTER_MAX)
			{
				counterTiltBackward++;
			}
			else
			{
				if (ServoValue[servL] > SERVO_INCREMENT)
				{
					servo[servL] -= SERVO_INCREMENT;
					servo[servR] += SERVO_INCREMENT;
				}
				counterTiltBackward = 0;
			}
		}
		else
		{
			counterTiltBackward = 0;
			counterTiltForward = 0;
		}

		// the speed toggler for smooth handling
		if (joy1Btn(2))
		{
			if (counterSmoothen < COUNTER_MAX)
			{
				counterSmoothen++;
			}
			else if (counterSmoothen == 0)
			{
				if (TELE_OP_SCALE == 0.85)
				{
					TELE_OP_SCALE = 0.3;
				}
				else TELE_OP_SCALE = 0.85;

				counterSmoothen = -120;
			}
		}
		else counterSmoothen++;

		// the lift buttons are automatic (motors)
		if (joy2Btn(8))
		{
			motor[liftR] = -LIFT_SPEED;
			lifted = true;
		}
		if (joy2Btn(7))
		{
			motor[liftL]= -LIFT_SPEED;
			lifted = true;
		}
		if (joy2Btn(6))
		{
			motor[liftR] = LIFT_SPEED;
			lifted = true;
		}
		if (joy2Btn(5))
		{
			motor[liftL] = LIFT_SPEED;
			lifted = true;
		}
		if (!lifted) // this is to make sure the motors stop
		{
			motor[liftL] = 0;
			motor[liftR] = 0;
		}
	}
}
